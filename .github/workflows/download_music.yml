name: ğŸ“¥ On-Demand Music Downloader (æŒ‰éœ€éŸ³ä¹ä¸‹è½½å™¨)

# å…è®¸æ‰‹åŠ¨æˆ–é€šè¿‡ API è§¦å‘å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      search_query:
        description: 'è¦æœç´¢å¹¶ä¸‹è½½çš„æ­Œæ›²å…³é”®è¯ï¼ˆä¾‹å¦‚: å”¯ä¸€ é‚“ç´«æ£‹ï¼‰'
        required: true
        type: string

jobs:
  download_and_commit:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout Repository)
        uses: actions/checkout@v4
        # å¿…é¡»ä½¿ç”¨ fetch-depth: 0 æ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­æ¨é€ä»£ç 
        with:
          fetch-depth: 0 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: ğŸ“¦ å®‰è£…ä¾èµ– (requests, bs4, pathlib)
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 
          # å®‰è£… lxml è§£æå™¨ä»¥æé«˜æ€§èƒ½
          pip install lxml

      # ------------------------------------------------------------------
      # FFmpeg å®‰è£… (é‡è¦: ç”¨äº AAC è½¬ MP3)
      # ------------------------------------------------------------------
      - name: ğŸ› ï¸ å®‰è£… FFmpeg (å¦‚æœéœ€è¦ AAC è½¬æ¢)
        run: sudo apt-get install ffmpeg -y
        
      # ------------------------------------------------------------------
      # æ‰§è¡Œ Python è„šæœ¬
      # ------------------------------------------------------------------
      - name: ğŸš€ æ‰§è¡Œä¸‹è½½è„šæœ¬å¹¶ä¸‹è½½ç¬¬ä¸€é¦–æ­Œ
        # ä½¿ç”¨è¾“å…¥çš„å…³é”®è¯ä½œä¸ºè„šæœ¬çš„å‘½ä»¤è¡Œå‚æ•°
        run: python download_music.py "${{ github.event.inputs.search_query }}"
        # å¿½ç•¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä»¥ä¾¿ä¸‹ä¸€æ­¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
        continue-on-error: true

      # ------------------------------------------------------------------
      # æ£€æŸ¥å˜åŠ¨å¹¶æ¨é€ (å…³é”®æ­¥éª¤)
      # ------------------------------------------------------------------
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŠ¨
        id: git_status
        run: |
          # æ£€æŸ¥ downloads æ–‡ä»¶å¤¹æ˜¯å¦æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          if [[ $(git status --porcelain downloads) ]]; then
            echo "::set-output name=files_changed::true"
          else
            echo "::set-output name=files_changed::false"
          fi

      - name: â« æäº¤å¹¶æ¨é€æ–°æ–‡ä»¶åˆ°ä»“åº“
        if: steps.git_status.outputs.files_changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat(download): è‡ªåŠ¨ä¸‹è½½æ­Œæ›²: ${{ github.event.inputs.search_query }}'
          # ä»…æ¨é€ downloads ç›®å½•ä¸‹çš„æ–‡ä»¶
          commit_options: '--no-verify --quiet --allow-empty' 
          file_pattern: 'downloads/*'
          # GitHub Token é»˜è®¤æ˜¯å¯ç”¨çš„
          branch: main # æ›¿æ¢ä¸ºæ‚¨çš„ä¸»åˆ†æ”¯åç§°
